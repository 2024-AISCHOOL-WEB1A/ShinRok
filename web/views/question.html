<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ question.BOARD_TITLE }}</title>
    <script src="https://kit.fontawesome.com/71a327e855.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../public/question.css">
</head>

<body>
    <!-- 최상단 배너 -->
    <section id="banner">
        <div class="content">
            <header>
                <img class="murukLogo"
                    src="https://jsh-1.s3.ap-northeast-2.amazonaws.com/board/63f25f8a5b4f5ebf2c08e948eaa4ded2" alt="">
            </header>
        </div>
    </section>

    <!-- 왼쪽 사이드바 -->
    <aside class="leftSidebar">
        <nav>
            <ul>
                <li><a href="/">HOME</a></li>
                <li class="profile"><a href="#">Profile</a></li>
                <li><a href="/freeList">자유게시판</a></li>
                <li><a href="/board/bragList">자랑하기</a></li>
                <li><a href="#">인기글</a></li>
                <li><a href="#">공지사항</a></li>
                <li><a href="#">질문게시판</a></li>
            </ul>
        </nav>
        <!-- 아래쪽 사이드바(페이지 이동) -->
        <nav class="underSidebar">
            <ul>
                <li><a href="/diary">Diary</a></li>
                <li><a href="/predict">병충해 진단</a></li>
                <li><a href="/dictionary/home">식물 도감</a></li>
                <li><a href="/myPage">마이페이지</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Body 전체 -->
    <form action="/board/question" id="quesDetailForm" class="quesdetailForm" method="POST">
        <!-- 게시글 상세페이지 -->
        <table class="table">
            {% if user %}
            <input type="hidden" name="user_idx" value="{{user.idx}}">
            {% endif %}

            <!-- 게시물 제목부분 -->
            <tr>
                <td colspan="4">
                    <h4 id="category">카테고리>{{question.BOARD_CATE}} </h4>
                </td>
            </tr>

            <!-- 타이틀 제목 -->
            <tr>
                <td colspan="4">
                    <h2 id="titleName">{{ question.BOARD_TITLE }}</h2>
                </td>
            </tr>

            <tr id="spaceTitle">

                <td rowspan="2" id="profilePic"><img src='{{question.USER_PICTURE}}'></td>
                <td id="userNick"> {{ question.USER_NICK }}</td>
            <tr class="titleList">
                <td id="titleDate">{{ question.BOARD_DATE | date("YYYY-MM-DD HH:mm") }}
                    <input type="hidden" name="board_idx" value="{{question.BOARD_IDX}}">
                </td>
                <td id="titleTd">조회수<span>: {{ question.BOARD_COUNT }}</span></td>
                <td id="titleTd" colspan="2"><i class="fa-regular fa-comment-dots">답변 수</i><span>: {{ commentCount
                        }}</span></td>
            </tr>
            </tr>

            <!-- 가로선 추가 -->
            <tr>
                <td colspan="4">
                    <div class="horizontal-line"></div>
                </td>
            </tr>
            <!-- ------------------- 게시물 내용이 보이는 부분 ----------------- -->
            <tr class="but">
                {% if user %}
                <input type="hidden" name="idx" value={{user.idx}}>
                {% endif %}
                <td class="addImage" colspan="5">
                    <!-- 이미지 혹은 내용을 넣을 공간 -->
                    {% if question.BOARD_IMG %}
                    <img src="{{ question.BOARD_IMG }}" alt="게시글 이미지" id="postImg">
                    {% endif %}
                    <br> <br>
                    <span>{{ question.BOARD_CONTENT }}</span>
                </td>
            </tr>

            <!-- 게시글 작성한 유저가 접속시 수정하기 버튼 생성 -->
            <tr>
                <div>
                    <td id="answer"><a href="/answer" class="answer"><button type="button">답변하기</button></a></td>
                </div>
                <div class="align-buttons">
                    <td id="changeBtn"><a href="/changePost" class="change_post"><button type="button">수정하기</button></a>
                    </td>
                </div>
            </tr>

            <!-- 답변 목록 & 작성하기 부분 -->
            <div id="answerFormContainer" style="display: none;">
                <form id="answerForm" enctype="multipart/form-data">
                    <input type="hidden" name="board_idx" value="{{ question.BOARD_IDX }}">
                    <input type="hidden" name="user_idx" value="{{ user.idx }}">
                    <textarea name="content" placeholder="내용을 입력하세요"></textarea>
                    <input type="file" name="image" accept="image/*">
                    <button type="submit">등록하기</button>
                </form>
            </div>
            </td>
            </tr>
        </table>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.getElementById('answerBtn').addEventListener('click', function () {
            document.getElementById('answerFormContainer').style.display = 'block';
        });

        document.getElementById('quesDetailForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {
                user_idx: formData.get('user_idx'),
                board_idx: formData.get('board_idx'),
                title: formData.get('title'),
                content: formData.get('content'),
                img: formData.get('img')
            };

            axios.post('http://localhost:3000/board/answerComment', formData)
                .then(response => {
                    if (response.data.success) {
                        // 답변 목록 업데이트
                        loadAnswers(formData.get('board_idx'));
                        document.getElementById('answerFormContainer').style.display = 'none';
                    } else {
                        alert('답변 등록에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        function loadComments(boardIdx) {
            axios.get(`http://localhost:3000/board/asr?board_idx=${boardIdx}`)
                .then(response => {
                    const commentList = document.getElementById('commentList');
                    commentList.innerHTML = '';

                    response.data.comments.forEach(comment => {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.className = 'addImage';
                        td.colSpan = '5';

                        if (comment.BOARD_IMG) {
                            const img = document.createElement('img');
                            img.src = comment.BOARD_IMG;
                            img.alt = '게시글 이미지';
                            img.id = 'postImg';
                            td.appendChild(img);
                        }

                        const br = document.createElement('br');
                        td.appendChild(br);
                        td.appendChild(br.cloneNode());

                        const span = document.createElement('span');
                        span.textContent = comment.BOARD_CONTENT;
                        td.appendChild(span);

                        tr.appendChild(td);
                        commentList.appendChild(tr);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }


        // 페이지 로드 시 댓글 목록 로드
        const boardIdx = "{{ question.BOARD_IDX }}"; // 템플릿 변수 사용
        loadComments(boardIdx); // 해당 게시글 ID로 호출
    </script>

</body>

</html>